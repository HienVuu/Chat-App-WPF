<Window x:Class="WpfChatApp.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:WpfChatApp"
        mc:Ignorable="d"
        Title="WPF Group Chat" Height="600" Width="650" MinWidth="500" MinHeight="400"
        WindowStartupLocation="CenterScreen"
        Background="#FFE5E5E5"
        Closing="Window_Closing">

    <Window.Resources>
        <!-- Các Resource màu sắc và Style -->
        <SolidColorBrush x:Key="MyMessageBrush" Color="#FF007AFF"/>
        <SolidColorBrush x:Key="TheirMessageBrush" Color="#FFFFFFFF"/>
        <SolidColorBrush x:Key="SystemMessageBrush" Color="#F0F0F0"/>
        <SolidColorBrush x:Key="ReplyBackgroundBrush" Color="#E8EAF6"/>
        <SolidColorBrush x:Key="FileMessageBrush" Color="#E8F5E9"/>
        <SolidColorBrush x:Key="SendButtonBrush" Color="#FF007AFF"/>
        <SolidColorBrush x:Key="ClientButtonBrush" Color="#FF007AFF"/>
        <SolidColorBrush x:Key="WindowBackgroundBrush" Color="#FFE5E5E5"/>
        <SolidColorBrush x:Key="OnlineStatusBrush" Color="#2E7D32"/>
        <SolidColorBrush x:Key="UserListBackgroundBrush" Color="#F5F5F5"/>

        <Style x:Key="AccentButtonStyle" TargetType="Button">
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Background" Value="{StaticResource ClientButtonBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="15">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.8"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="EmojiButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="FontSize" Value="24"/>
            <Setter Property="Margin" Value="3"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>

        <DataTemplate x:Key="OnlineUserTemplate">
            <StackPanel Orientation="Horizontal" Margin="5">
                <Ellipse Width="10" Height="10" Fill="{StaticResource OnlineStatusBrush}" VerticalAlignment="Center"/>
                <TextBlock Text="{Binding}" Margin="8,0,0,0" VerticalAlignment="Center"/>
            </StackPanel>
        </DataTemplate>

        <DataTemplate x:Key="MessageTemplate" DataType="{x:Type local:ChatMessage}">
            <Grid>
                <!-- Tin nhắn của người dùng (văn bản & trả lời) -->
                <Border x:Name="UserMessageBorder" CornerRadius="15" Padding="10" Margin="0,5,60,5" MaxWidth="350" HorizontalAlignment="{Binding HorizontalAlignment}" Background="{StaticResource TheirMessageBrush}">
                    <Border.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="Sao chép" DataContext="{Binding}" Click="CopyMenuItem_Click"/>
                            <MenuItem Header="Trả lời" DataContext="{Binding}" Click="ReplyMenuItem_Click"/>
                        </ContextMenu>
                    </Border.ContextMenu>
                    <StackPanel>
                        <Border x:Name="ReplyContentBorder" Visibility="Collapsed" Background="{StaticResource ReplyBackgroundBrush}" CornerRadius="8" Padding="8" Margin="-10,-10,-10,8" BorderThickness="2,0,0,0" BorderBrush="{Binding SenderColor}">
                            <StackPanel>
                                <TextBlock x:Name="RepliedToUsernameText" Text="{Binding RepliedToUsername}" FontWeight="Bold" FontSize="11"/>
                                <TextBlock Text="{Binding RepliedToContent}" FontStyle="Italic" Foreground="Gray" TextTrimming="CharacterEllipsis" FontSize="11"/>
                            </StackPanel>
                        </Border>
                        <TextBlock x:Name="SenderNameText" Text="{Binding SenderName}" FontWeight="Bold" Foreground="{Binding SenderColor}"/>
                        <TextBlock x:Name="ContentText" Text="{Binding Content}" TextWrapping="Wrap" Margin="0,2,0,0"/>
                        <TextBlock x:Name="TimestampText" Text="{Binding SentTime, StringFormat='HH:mm'}" FontSize="10" Foreground="Gray" HorizontalAlignment="Right" Margin="0,5,0,-5"/>
                    </StackPanel>
                </Border>

                <!-- MỚI: Tin nhắn dạng tệp tin -->
                <Border x:Name="FileMessageBorder" Visibility="Collapsed" CornerRadius="15" Padding="10" Margin="0,5,60,5" MaxWidth="320" HorizontalAlignment="{Binding HorizontalAlignment}" Background="{StaticResource FileMessageBrush}">
                    <Border.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="Trả lời" DataContext="{Binding}" Click="ReplyMenuItem_Click"/>
                            <MenuItem Header="Lưu file" DataContext="{Binding}" Click="SaveFile_Click"/>
                        </ContextMenu>
                    </Border.ContextMenu>
                    <StackPanel>
                        <TextBlock Text="{Binding SenderName}" FontWeight="Bold" Foreground="{Binding SenderColor}"/>
                        <StackPanel Orientation="Horizontal" Margin="0,5,0,5">
                            <Path Data="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M13,9V3.5L18.5,9H13Z" Fill="Gray" Width="20" Height="20" Stretch="Uniform"/>
                            <TextBlock Text="{Binding FileName}" TextWrapping="Wrap" VerticalAlignment="Center" Margin="8,0,0,0"/>
                        </StackPanel>
                        <Button Content="Lưu file" HorizontalAlignment="Right" Background="LightGray" Padding="8,3" Cursor="Hand" Click="SaveFile_Click" DataContext="{Binding}"/>
                    </StackPanel>
                </Border>

                <!-- Tin nhắn hệ thống -->
                <Border x:Name="SystemMessageBorder" Visibility="Collapsed" CornerRadius="10" Padding="8,4" Margin="0,5" MaxWidth="380" Background="{StaticResource SystemMessageBrush}" HorizontalAlignment="Center">
                    <TextBlock Text="{Binding Content}" TextWrapping="Wrap" FontSize="11" FontStyle="Italic" Foreground="Gray" TextAlignment="Center"/>
                </Border>
            </Grid>

            <DataTemplate.Triggers>
                <DataTrigger Binding="{Binding IsReply}" Value="True">
                    <Setter TargetName="ReplyContentBorder" Property="Visibility" Value="Visible"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding IsFile}" Value="True">
                    <Setter TargetName="UserMessageBorder" Property="Visibility" Value="Collapsed"/>
                    <Setter TargetName="FileMessageBorder" Property="Visibility" Value="Visible"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding IsSentByMe}" Value="True">
                    <Setter TargetName="UserMessageBorder" Property="Background" Value="{StaticResource MyMessageBrush}" />
                    <Setter TargetName="SenderNameText" Property="Foreground" Value="White" />
                    <Setter TargetName="ContentText" Property="Foreground" Value="White" />
                    <Setter TargetName="TimestampText" Property="Foreground" Value="#B0E0FF" />
                    <Setter TargetName="RepliedToUsernameText" Property="Foreground" Value="White" />
                </DataTrigger>
                <DataTrigger Binding="{Binding SenderName}" Value="System">
                    <Setter TargetName="UserMessageBorder" Property="Visibility" Value="Collapsed"/>
                    <Setter TargetName="FileMessageBorder" Property="Visibility" Value="Collapsed"/>
                    <Setter TargetName="SystemMessageBorder" Property="Visibility" Value="Visible"/>
                </DataTrigger>
            </DataTemplate.Triggers>
        </DataTemplate>
    </Window.Resources>

    <!-- Bố cục chính với 2 cột -->
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>

        <!-- Cột 0: Khung chat chính -->
        <Grid Grid.Column="0">
            <Grid.Background>
                <LinearGradientBrush StartPoint="0.5,0" EndPoint="0.5,1">
                    <GradientStop Color="#A7FFEB" Offset="0.0" />
                    <GradientStop Color="#F8BBD0" Offset="1.0" />
                </LinearGradientBrush>
            </Grid.Background>
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <ScrollViewer Grid.Row="0" x:Name="MessagesScrollViewer" VerticalScrollBarVisibility="Auto" Margin="10,10,10,0">
                <ItemsControl x:Name="MessagesItemsControl" ItemTemplate="{StaticResource MessageTemplate}" />
            </ScrollViewer>

            <StackPanel Grid.Row="1" Margin="10">
                <Border x:Name="ReplyPreviewPanel" Visibility="Collapsed" Background="White" CornerRadius="10,10,0,0" Padding="8" BorderThickness="0,0,0,1" BorderBrush="#E0E0E0">
                    <Grid>
                        <StackPanel Margin="0,0,25,0">
                            <TextBlock x:Name="ReplyPreviewUsername" FontWeight="Bold" FontSize="11"/>
                            <TextBlock x:Name="ReplyPreviewContent" TextTrimming="CharacterEllipsis" FontStyle="Italic" Foreground="Gray" FontSize="11"/>
                        </StackPanel>
                        <Button x:Name="CancelReplyButton" Content="✕" HorizontalAlignment="Right" VerticalAlignment="Top" Width="20" Height="20" Background="Transparent" BorderThickness="0" FontWeight="Bold" Foreground="Gray" Click="CancelReplyButton_Click"/>
                    </Grid>
                </Border>
                <Border CornerRadius="15" Background="White">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <Button Grid.Column="0" x:Name="AttachFileButton" Width="40" Height="40" Background="Transparent" BorderThickness="0" Click="AttachFileButton_Click" ToolTip="Gửi tệp tin">
                            <Path Data="M19.5,9.5 L9.5,19.5 C7.8,21.2 5.2,21.2 3.5,19.5 C1.8,17.8 1.8,15.2 3.5,13.5 L13.5,3.5 C14.4,2.6 15.9,2.6 16.8,3.5 C17.7,4.4 17.7,5.9 16.8,6.8 L7.5,16.1 C7.1,16.5 6.4,16.5 6,16.1 C5.6,15.7 5.6,15 6,14.6 L14.7,6" Stroke="Gray" StrokeThickness="2"/>
                        </Button>
                        <TextBox Grid.Column="1" x:Name="MessageTextBox" BorderThickness="0" VerticalContentAlignment="Center" Margin="5,0" KeyDown="MessageTextBox_KeyDown" TextChanged="MessageTextBox_TextChanged" Text="Type a message..."/>
                        <Button Grid.Column="2" x:Name="EmojiButton" Content="😊" FontSize="18" Width="40" Height="40" Background="Transparent" BorderThickness="0" Click="EmojiButton_Click" ToolTip="Biểu tượng cảm xúc"/>
                        <Button Grid.Column="3" x:Name="SendButton" Width="40" Height="40" BorderThickness="0" IsEnabled="False" Click="SendButton_Click" ToolTip="Gửi">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Background" Value="Transparent"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border Background="{TemplateBinding Background}" CornerRadius="20">
                                                    <Path Data="M1,21 L23,12 L1,3 L1,10 L17,12 L1,14 L1,21 Z" Fill="{StaticResource SendButtonBrush}" Stretch="Uniform" Width="20" Height="20"/>
                                                </Border>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <Trigger Property="IsEnabled" Value="False">
                                            <Setter Property="Path.Fill" Value="LightGray"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                    </Grid>
                </Border>
            </StackPanel>
        </Grid>

        <!-- Đường kẻ phân chia cột -->
        <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Left" Background="LightGray" ResizeBehavior="PreviousAndNext"/>

        <!-- Cột 1: Danh sách người dùng online -->
        <Grid Grid.Column="1" MinWidth="150" MaxWidth="250" Background="{StaticResource UserListBackgroundBrush}">
            <DockPanel>
                <TextBlock DockPanel.Dock="Top" Text="ĐANG ONLINE" FontWeight="Bold" Foreground="Gray" Margin="10" HorizontalAlignment="Center"/>
                <Separator DockPanel.Dock="Top"/>
                <ListView x:Name="OnlineUsersListView" ItemTemplate="{StaticResource OnlineUserTemplate}" BorderThickness="0" Background="Transparent"/>
            </DockPanel>
        </Grid>

        <!-- Lớp phủ (Overlays) -->
        <Grid x:Name="ConnectionPanel" Grid.ColumnSpan="2" Background="{StaticResource WindowBackgroundBrush}">
            <Border Background="White" CornerRadius="20" Padding="30" Margin="30" VerticalAlignment="Center" HorizontalAlignment="Center" BorderBrush="#1F000000" BorderThickness="1">
                <Border.Effect>
                    <DropShadowEffect ShadowDepth="2" Color="Black" Opacity="0.15" BlurRadius="25"/>
                </Border.Effect>
                <StackPanel>
                    <TextBlock Text="Welcome to Chat!" FontSize="24" FontWeight="Bold" HorizontalAlignment="Center"/>
                    <TextBlock Text="Join a chat room" FontSize="14" Foreground="Gray" HorizontalAlignment="Center" Margin="0,0,0,20"/>
                    <Grid Margin="0,0,0,10">
                        <Label Content="Nickname:" FontWeight="Medium"/>
                        <TextBox x:Name="NicknameTextBox" Text="Guest" HorizontalAlignment="Right" Width="250" VerticalContentAlignment="Center"/>
                    </Grid>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <Label Grid.Column="0" Content="Server IP:" FontWeight="Medium"/>
                        <TextBox Grid.Column="1" x:Name="IpAddressTextBox" Text="127.0.0.1" VerticalContentAlignment="Center"/>
                        <Label Grid.Column="2" Content="Port:" Margin="10,0,0,0" FontWeight="Medium"/>
                        <TextBox Grid.Column="3" x:Name="PortTextBox" Text="8888" Width="50" VerticalContentAlignment="Center"/>
                    </Grid>
                    <Button x:Name="ConnectButton" Content="Join Chat" Style="{StaticResource AccentButtonStyle}" Width="140" Height="40" Margin="0,20,0,0" Click="ConnectButton_Click"/>
                </StackPanel>
            </Border>
        </Grid>
        <Popup x:Name="EmojiPopup" Placement="Top" PlacementTarget="{Binding ElementName=EmojiButton}" StaysOpen="False" AllowsTransparency="True">
            <Border Background="#F1F1F1" CornerRadius="10" BorderThickness="1" BorderBrush="#DDDDDD" Padding="5">
                <WrapPanel Width="200">
                    <Button Content="😀" Style="{StaticResource EmojiButtonStyle}" Click="Emoji_Click"/>
                    <Button Content="😂" Style="{StaticResource EmojiButtonStyle}" Click="Emoji_Click"/>
                    <Button Content="😍" Style="{StaticResource EmojiButtonStyle}" Click="Emoji_Click"/>
                    <Button Content="👍" Style="{StaticResource EmojiButtonStyle}" Click="Emoji_Click"/>
                    <Button Content="❤️" Style="{StaticResource EmojiButtonStyle}" Click="Emoji_Click"/>
                    <Button Content="🔥" Style="{StaticResource EmojiButtonStyle}" Click="Emoji_Click"/>
                    <Button Content="🎉" Style="{StaticResource EmojiButtonStyle}" Click="Emoji_Click"/>
                    <Button Content="🤔" Style="{StaticResource EmojiButtonStyle}" Click="Emoji_Click"/>
                </WrapPanel>
            </Border>
        </Popup>
    </Grid>
</Window>
